<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üçâ Cheklar</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; padding: 20px; }
    h1 { text-align: center; color: #4ade80; margin-bottom: 20px; }
    .section { margin: 30px 0; background: #222; padding: 15px; border-radius: 8px; }
    .section h2 { color: #60a5fa; margin-bottom: 10px; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; border: none; border-radius: 5px; }
    input { background: #333; color: #fff; font-size: 16px; }
    button { background: #4ade80; color: #000; font-weight: bold; cursor: pointer; font-size: 16px; }
    button:disabled { background: #555; cursor: not-allowed; }
    .receipt-link { word-break: break-all; font-size: 14px; color: #38bdf8; }
    .receipt-item { margin-bottom: 10px; background: #333; padding: 10px; border-radius: 5px; }
    .back-btn { display: block; text-align:center; background: #444; padding: 10px; border-radius:5px; color:#fff; text-decoration:none; margin-top:20px;}
    .result { margin-top:10px; font-size:16px; }
  </style>
</head>
<body>
  <h1>üçâ Cheklar Tizimi</h1>

  <!-- Generate -->
  <div class="section" id="generate-section">
    <h2>‚úÖ Chek Yaratish</h2>
    <p>3% komissiya olinadi. Masalan, 100 kiritsangiz, 97 arbuz chek bo‚Äòladi.</p>
    <p>Jami arbuzlaringiz: <strong><span id="total-watermelons">‚Ä¶</span></strong></p>
    <input type="number" id="input-amount" placeholder="Chek summasi (butun son)" min="1">
    <input type="number" id="input-users" placeholder="Nechiga bo‚Äòlish (N)" min="1">
    <button id="generate-btn">Chek yaratish</button>
    <div id="generated-link" class="receipt-link"></div>
  </div>

  <!-- My inactive receipts -->
  <div class="section">
    <h2>üóÉÔ∏è Mening Faollashmagan Cheklarim</h2>
    <div id="receipt-list">Yuklanmoqda‚Ä¶</div>
  </div>

  <!-- Activate -->
  <div class="section">
    <h2>üéÅ Chekni Faollashtirish</h2>
    <input type="text" id="activate-id" placeholder="Chek ID (8 belgili)" maxlength="8">
    <button id="activate-btn">Faollashtirish</button>
    <div id="activation-result" class="result"></div>
  </div>

  <a href="asosiy.html" class="back-btn">‚¨ÖÔ∏è Ortga</a>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Your Firebase config
    const firebaseConfig = {
      apiKey: "...",
      authDomain: "...",
      databaseURL: "...",
      projectId: "...",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    auth.onAuthStateChanged(async user => {
      if (!user) return location.href = "login.html";
      const uid = user.uid;
      const totalSpan = document.getElementById("total-watermelons");
      const receiptList = document.getElementById("receipt-list");

      // load total watermelons
      const totSnap = await db.ref(`players/${uid}/watermelons`).get();
      totalSpan.textContent = totSnap.val() || 0;

      // GENERATE
      document.getElementById("generate-btn").onclick = async () => {
        const raw = parseInt(document.getElementById("input-amount").value);
        const people = parseInt(document.getElementById("input-users").value);
        if (!raw||raw<1||!people||people<1) {
          return alert("Ikkala maydonni ham to‚Äòg‚Äòri to‚Äòldiring");
        }
        const amountAfterFee = Math.floor(raw * 0.97);
        const perUser = Math.floor(amountAfterFee / people);
        if (perUser < 1) {
          return alert("Bo‚Äòlib bo‚Äòlmaydi‚Äîarbuz juda kam");
        }

        // check balance
        const balSnap = await db.ref(`players/${uid}/watermelons`).get();
        const balance = balSnap.val()||0;
        if (balance < raw) return alert("Yetarli arbuz yo‚Äòq");

        // deduct & create
        const id = Math.random().toString(36).substr(2,8);
        const rec = { from: uid, amount: amountAfterFee, totalUsers: people, perUser, usedBy: {} };
        await db.ref(`players/${uid}/watermelons`).set(balance - raw);
        await db.ref(`cheklar/${id}`).set(rec);

        const link = `${location.origin}/checks.html?activate=${id}`;
        document.getElementById("generated-link").innerHTML =
          `‚úÖ ID: <strong>${id}</strong><br>`+
          `Link: <a href="${link}" target="_blank">${link}</a>`;
      };

      // LIST MY INACTIVE
      db.ref("cheklar").on("value", snap => {
        receiptList.innerHTML = "";
        const data = snap.val()||{};
        for (const [id, d] of Object.entries(data)) {
          if (d.from===uid && Object.keys(d.usedBy).length < d.totalUsers) {
            const div = document.createElement("div");
            div.className = "receipt-item";
            div.innerHTML = `ID:<strong>${id}</strong> ‚Äî ${d.perUser} arbuz √ó ${d.totalUsers} = ${d.amount}`;
            receiptList.appendChild(div);
          }
        }
      });

      // ACTIVATE
      document.getElementById("activate-btn").onclick = async () => {
        const id = document.getElementById("activate-id").value.trim();
        if (id.length!==8) return alert("8 belgili ID kiriting");
        const ref = db.ref(`cheklar/${id}`);
        ref.transaction(rec => {
          if (!rec) return;               // no such
          if (!rec.usedBy) rec.usedBy={};
          if (rec.usedBy[uid]) return;    // you already used
          if (Object.keys(rec.usedBy).length >= rec.totalUsers) return; // full
          rec.usedBy[uid]=true;
          return rec;
        }, async (err, committed, snap2) => {
          if (!committed) return show("‚ùå Faollashmadi");
          const rec = snap2.val();
          const gain = rec.perUser;
          const myRef = db.ref(`players/${uid}/watermelons`);
          const mySnap = await myRef.get();
          await myRef.set((mySnap.val()||0) + gain);
          show(`‚úÖ ${gain} arbuz qo‚Äòshildi!`);
        });
      };

      // auto-activate via URL
      const params = new URLSearchParams(window.location.search);
      if (params.has("activate")) {
        document.getElementById("activate-id").value = params.get("activate");
        document.getElementById("activate-btn").click();
      }

      function show(msg) {
        document.getElementById("activation-result").innerHTML =
          `<p style="color:#4ade80">${msg}</p>`;
      }
    });
  </script>
</body>
</html>
